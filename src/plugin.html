<plugin>


    <script src=src/skewT.js></script>
    <script src=src/wind_barbs.js></script>
    <script src=src/Sample_data.js></script>

	<script>

    import picker from '@windy/picker'
    import utils from '@windy/utils'
    import store from '@windy/store'
    import map from '@windy/map'

	
	/***************************************************
	 * SkewT.js 
	 *
	 * A windy plugin written by John C. Kealy 
	 * Email any queries to me at johnckealy@gmail.com
	 * Dec 2018
	 *
	 ***************************************************/



	var DateTime = "Thu 27 Dec 00:00:00 UTC 2018"


    window.w = 0.8*window.innerHeight
    window.h = 0.7*window.innerHeight

    window.barbsw = 0.08*w
    window.barbsh = h

 	const activate_SkewT = latLon => {
        let { lat, lon } = picker.getParams()
        draw_skewT();
        draw_windbarb();
		console.log('Picker is at', lat, lon)
	}


    picker.on('pickerOpened', activate_SkewT )
    picker.on('pickerMoved', activate_SkewT )

	const ondrag = () => {
 		translate_obj('skewTd3');
	};
    map.on('drag', ondrag);

    
	function draw_skewT() {
 
		d3.select("#skewTbox").remove() 
        // svg to set the skewT into
	    window.svg = d3.select(".leaflet-popup-pane").append("svg")
	        .attr("height", h)
	        .attr("width", w+barbsw)
	        .attr('id', 'skewTbox');
	    svg.append("rect")
	        .attr("height", h)
	        .attr("width", w)
	        .attr("fill", "white")
	        .attr("opacity", 0.7)
	        .attr('id', 'skewTd3');


        cskewT(Pascent, Tascent, Tdascent, DateTime)
 		translate_obj() 

	};


	function translate_obj() {

 		var GetTransform= document.getElementsByClassName("leaflet-map-pane")[0]

        var Attrtxt = GetTransform.getAttribute("style")
 		var NUMERIC_REGEXP = /[-]{0,1}[\d]*[\.]{0,1}[\d]+/g;
        var Xpx = -1*Number(Attrtxt.match(NUMERIC_REGEXP)[1]) + 50
        var Ypx = -1*Number(Attrtxt.match(NUMERIC_REGEXP)[2]) + 90
        var Zpx = Number(Attrtxt.match(NUMERIC_REGEXP)[3])

        var translation = "translate3d("+Xpx+"px, "+Ypx+"px,  "+Zpx+"px)";

        var S = document.getElementById('skewTbox')
		S.setAttribute("style", "transform: "+translation)

	};


    function draw_windbarb() {

	    window.svgbarbs = svg.append("rect")
	        .attr('x', w)
	        .attr("height", barbsh)
	        .attr("width", barbsw)
	        .attr("fill", "#1A1A1A")
	        .attr("opacity", 0.8)
	        .attr('id', 'barbsd3');

        cbarbs(Pascent, U, V)
    };




	</script>

</plugin>
