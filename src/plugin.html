<plugin>

  <div id="skewt-wraper" class="shy left-border right-border radar-wrapper">
    <div id="navigator">
      <div id="skewt-header">
        <div id="ft-title">
          <p>To display a Skew-T, choose a <br> location and open the picker...</p>
        </div>
        <div id="skewt-control-panel" style="display: none">
          <span id='closebutton' class='controls'>&#x2715;</span>
          <span id='zoom-out' class='controls'>&#x1f50d&#x2212</span>
          <span id='zoom-in' class='controls'>&#x1f50d&#x2b</span>
        </div>
        <div id="skewt-container">

        </div>
      </div>
    </div>
  </div>


  <!-- load dependent scripts -->
  <script src=src/skewT.js> </script> 
  <script src=src/wind_barbs.js> </script> 
  <script src=src/parcel.js> </script> 
  
  <script>

    import picker from '@windy/picker';
    import utils from '@windy/utils';
    import store from '@windy/store';
    import map from '@windy/map';
    import broadcast from '@windy/broadcast';
   
    
    /************************************************************************
     * SkewT.js
     *
     * A windy plugin written by John C. Kealy.
     *
     * Based on a stripped-down version of the https://www.skewt.org code.
     *
     * Email any queries to me at johnckealy.dev@gmail.com.
     *
     * Dec 2018
     * Updated Aug 2020
     *
     *************************************************************************/
    const pluginDataLoader = W.require('@plugins/plugin-data-loader');
    var PickerOn = false;
    var Pressures;
    var zoomed = false;
    var startpressure = 1050;

    // Set global variables for window size. These will
    // need to optimised later.
    function set_dimensions() {

      const forecastTable = document.getElementsByClassName('table-wrapper')[0];
      let wHeight = window.innerHeight;
      if (forecastTable) {
        wHeight -= forecastTable.clientHeight;
      }


      window.w = 0.75 * wHeight;
      window.h = 0.7 * wHeight;

      window.barbsw = 0.08 * w;
      window.barbsh = h;

      window.x_offset = 50;
      window.y_offset = 90;
    }

    const options = {
      key: 'psfAt10AZ7JJCoM3kz0U1ytDhTiLNJN3',
      plugin: 'windy-plugin-skewt'
    }

    const load = pluginDataLoader(options)


    // Run the plugin based on invoking the picker
    const activate_SkewT = latLon => {

      set_dimensions();

      let {
        lat,
        lon
      } = picker.getParams()
      PickerOn = true;

      if (zoomed) {
        var endpressure = 600;
      } else {
        var endpressure = 150;
      }
      document.getElementById('skewt-control-panel').style.display = "inline-block";

      set_dimensions();
      var introtext = document.getElementById('ft-title')
      introtext.style.display = "none";
      zoom_button();

      const dataOptions = {
        model: store.get('product'),
        lat: lat,
        lon: lon
      }

      // load up a an array with a timeseries of the surface
      // pressure using the 'forecast' API call.
      load('forecast', dataOptions).then(({
        data
      }) => {
        Pressures = []
        for (const key of Object.keys(data.data)) {
          for (var i = 0; i < data.data[key].length; i++) {
            Pressures.push(data.data[key][i].pressure / 100)
          }
        }
      });


      //Load point forecast for lat, lon.
      load('airData', dataOptions).then(({
        data
      }) => {

        var current_timestamp = store.get('timestamp');
        var tidx = gettimestamp(current_timestamp, data.data.hours);

        try {
          var Pascent = [Pressures[tidx], 950, 925, 900, 850, 800, 700, 600, 500, 400, 300, 200, 150];
        } catch(err) {
          console.log("There was a problem with the data loader, retrying...")
          setTimeout(function(){ activate_SkewT(); }, 1000);
        }

        var Tdascent = get_data(data, 'dewpoint', tidx);
        var Tascent = get_data(data, 'temp', tidx);


        for (var z = 0; z < Tdascent.length; z++) {
          Tascent[z] = Math.round(100 * (Tascent[z] - 273.15)) / 100;
          Tdascent[z] = Math.round(100 * (Tdascent[z] - 273.15)) / 100;
        };
        var U = get_data(data, 'wind_u', tidx);
        var V = get_data(data, 'wind_v', tidx);

        // draw the skewT and the windbarbs. These functions are stored
        // in dedicated files.
        draw_skewT(Pascent, Tascent, Tdascent, startpressure, endpressure);
        cbarbs(Pascent, Tascent, U, V, current_timestamp, dataOptions, startpressure, endpressure);
      });
    }

    // As the picker appears or moves, draw the SkewT at the new latlon point
    picker.on('pickerOpened', activate_SkewT)
    picker.on('pickerMoved', activate_SkewT)
    store.on('timestamp', function () {
      if (PickerOn) {
        activate_SkewT();
      }
    })

    // close the skewT when the picker is closed
    const close_skewT = () => {
      d3.select("#skewTbox").remove();
      PickerOn = false;
      const controls = document.getElementById('skewt-control-panel')
      controls.style.display = "none";
      const ftTitle = document.getElementById('ft-title')
      ftTitle.style.display = "display-block";
    }
    picker.on('pickerClosed', close_skewT)


    function draw_skewT(Pascent, Tascent, Tdascent, startpressure, endpressure) {
      // When invoked, draw the skewT and also update the position if necessary
      cskewT(Pascent, Tascent, Tdascent, startpressure, endpressure)
    };




    function zoom_button() {
      var zoomOut = document.getElementById('zoom-out')
      var zoomIn = document.getElementById('zoom-in')
      var closeButton = document.getElementById('closebutton')
      zoomIn.addEventListener("click", function () {
        zoomed = true;
        activate_SkewT();
      });
      zoomOut.addEventListener("click", function () {
        zoomed = false;
        activate_SkewT();
      });
      closeButton.addEventListener("click", function () {
        close_skewT();
      });
    }


    function gettimestamp(current_timestamp, h) {
      var i = 0;
      var minDiff = 99999999999;
      var tidx;
      for (i in h) {
        var m = Math.abs(current_timestamp - h[i])
        if (m < minDiff) {
          minDiff = m
          tidx = i
        };
      };
      return tidx;
    };


    function get_data(data, field, tidx) {
      const pLevels = ['-surface', '-950h', '-925h', '-900h', '-850h',
                       '-800h', '-700h', '-600h', '-500h', '-400h', 
                       '-300h', '-200h', '-150h'];
      let ascent = [];
      pLevels.forEach((pLevel) => {
        ascent.push(data.data[field + pLevel][tidx]);
      })

      return ascent
    }

    W.map.on("click", e => {
      broadcast.fire('rqstOpen', 'picker', { lat: e.latlng.lat, lon: e.latlng.lng })
      picker.on('pickerOpened', () => {
        document.getElementById('windy-plugin-skewt').style.display = 'block';
      });
    }) 

  </script>

</plugin>
